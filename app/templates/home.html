<!DOCTYPE html>
<html>
<head>
    <title>Exercise Counter</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0; /* Optional: set a background color */
        }
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        video, img {
            width: 80%; /* Adjust the width as needed */
            height: auto; /* Maintain aspect ratio */
            border: 2px solid #000; /* Optional: add a border */
        }
    </style>
</head>
<body>
    <div class="container">
        <video id="video" autoplay></video>
        <img id="processed" alt="Processed Video Feed">
    </div>
    <script>
        const video = document.getElementById('video');
        const processed = document.getElementById('processed');
        const ws = new WebSocket('ws://' + window.location.host + '/ws/video/');

        ws.onopen = function () {
            console.log('WebSocket connection opened');
        };

        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);
            processed.src = 'data:image/jpeg;base64,' + data.frame;
        };

        ws.onerror = function (error) {
            console.error('WebSocket error:', error);
        };

        ws.onclose = function () {
            console.log('WebSocket connection closed');
        };

        // Access the user's webcam
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                const mediaStreamTrack = stream.getVideoTracks()[0];
                const imageCapture = new ImageCapture(mediaStreamTrack);

                // Capture a frame every 100ms and send to the server
                setInterval(() => {
                    imageCapture.grabFrame()
                        .then(imageBitmap => {
                            const canvas = document.createElement('canvas');
                            canvas.width = imageBitmap.width;
                            canvas.height = imageBitmap.height;
                            const context = canvas.getContext('2d');
                            context.drawImage(imageBitmap, 0, 0, canvas.width, canvas.height);
                            canvas.toBlob(blob => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    const base64data = reader.result.split(',')[1];
                                    ws.send(JSON.stringify({ frame: base64data }));
                                };
                                reader.readAsDataURL(blob);
                            }, 'image/jpeg');
                        })
                        .catch(error => console.error('Error grabbing frame:', error));
                }, 100);
            })
            .catch(err => {
                console.error('Error accessing the webcam: ', err);
            });
    </script>
</body>
</html>
